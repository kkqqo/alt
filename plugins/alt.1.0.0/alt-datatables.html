<script id="datatables" type="text/x-template">
    <table class="table table-hover table-condensed table-bordered display" style="width:100%">
        <slot></slot>
    </table>
</script>

<script>
    Vue.component("alt-datatables", {
        template: document.currentScript.ownerDocument.getElementById("datatables"),
        data() {
            return {
                table: null,
                columns: []
            }
        },
        props: {

        },
        mounted() {
            this.columns = JSON.parse(this.$attrs["data-columns"]);
            this.table = $(this.$el).DataTable({
                "dom":
                    "<'box'<'box-body'" +
                    "<'row'<'col-sm-6'l><'col-sm-6'>>" +
                    "<'row'<'col-sm-12'tr>>" +
                    "<'row'<'col-sm-5'i><'col-sm-7'p>>" +
                    ">>"
            });

            this.table.on("preXhr.dt",()=>{
                $(this.$el).closest('.box').data("box").showLoading()
            });

            this.table.on("xhr.dt",()=>{
                $(this.$el).closest('.box').data("box").hideLoading()
            });


            var thead = $("<thead>");
            var tr = $("<tr class='search'>").appendTo(thead);
            $(this.$el).find("thead").after(thead);

            if (this.isSearchable()) {
                this.columns.forEach((o, i) => {
                    var td = $("<td>");
                    td.appendTo(tr);
                    var column=this.table.columns(i);

                    if (!o.searchable) return;

                    if (o.searchType == "text") {
                        var search = $("<input class='form-control input-sm'>");
                        td.append(search);

                        search.keyup((e) => {
                            var code = (e.keyCode ? e.keyCode : e.which);
                            if (code == 13) {
                                this.table.columns(i).search(search.val()).draw();
                            }
                        });
                    }else if(o.searchType=="select"){
                        var search=$("<select class='form-control input-sm'>");
                        var opt=$("<option>");
                        search.append(opt);

                        o.searchOption.forEach((o)=>{
                            var opt=$("<option>");
                            opt.text(o.label);
                            opt.val(o.value);
                            search.append(opt);
                        });

                        search.on("change",()=>{
                            column.search(search.val()).draw();
                        });

                        td.append(search);
                    }else if(o.searchType=="date"){
                        var search=$('<input class="form-control input-sm" value="" />');
                        search.daterangepicker({
                            //singleDatePicker: true,
                            opens: "center",
                            showDropdowns: true,
                            //"autoApply": true,
                            autoUpdateInput: false,
                            locale: {
                                format: 'YYYY-MM-DD',
                                cancelLabel:'Clear'
                            },ranges: {
                                'Today': [moment(), moment()],
                                'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                                'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                                'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                                'This Month': [moment().startOf('month'), moment().endOf('month')],
                                'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                             }
                        });

                        search.on('apply.daterangepicker', (ev, picker) => {

                            if(picker.startDate.format("YYYY-MM-DD") == picker.endDate.format("YYYY-MM-DD")){
                                search.val(picker.startDate.format("YYYY-MM-DD"));
                            }else{
                                search.val(picker.startDate.format("YYYY-MM-DD")+ " to "+picker.endDate.format("YYYY-MM-DD"));
                            }
         
                            
                            var s={};
                            s.from=picker.startDate.format("YYYY-MM-DD");
                            s.to=picker.endDate.format("YYYY-MM-DD");

                            column.search(JSON.stringify(s)).draw();

                        });

                        search.on('cancel.daterangepicker', function(ev, picker) {
                            search.val("");
                            column.search("").draw();
                          });

                        td.append(search);

                        
                        
                    }

                });
            }
        }, methods: {
            isSearchable() {
                return this.columns.some(function (c) {
                    return c.searchable;
                });
            }
        }
    });
</script>