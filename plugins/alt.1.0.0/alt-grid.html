<template id="alt-grid-section">
    <section :style="getStyle()">
        <slot ref="s"></slot>
    </section>
</template>

<script>
    Vue.component("alt-grid-section", {
        template: document.currentScript.ownerDocument.getElementById("alt-grid-section"),
        computed: {
            box() {
                if (!this.$slots.default) return [];
                return this.$children.filter(o => {
                    return o.$vnode.componentOptions.tag == "alt-box";
                });
            }
        }, data() {
            return {
                isDragDrop: false
            }
        }, mounted() {

            this.$children.forEach(c => {
                c.$on("pinned", (v) => {
                    this.$emit("pinned", v);
                });
            });
        }, methods: {
            getStyle() {
                if (this.isDragDrop) {
                    return { "min-height": "100px" };
                } else {
                    return { "min-height": "0px" };
                }
            }, isPinned() {
                //no children
                if (this.box.length == 0) return true;
                return this.box.every((b) => {
                    return b.isPinned;
                });
            }, startSort() {
                this.isDragDrop=true;
                this.box.forEach(b=>b.unpin());
                $(this.$el).sortable({
                    placeholder: "sort-highlight",
                    connectWith: ".connectedSortable",
                    handle: ".box-header, .nav-tabs",
                    forcePlaceholderSize: true,
                    zIndex: 999999
                }).on("sortstop", (event, ui) => {
                    this.$emit("sortstop");
                });
            }, endSort() {
                this.isDragDrop=false;
                this.box.forEach(b=>b.pin());
                $(this.$el).sortable('destroy');
            }
        }
    });
</script>

<template id="alt-grid">
    <div>
        <slot></slot>
    </div>
</template>

<script>
    Vue.component("alt-grid", {
        template: document.currentScript.ownerDocument.getElementById("alt-grid"),
        props: {
            dataUrl: String,
            sortable: Boolean
        },
        mounted() {
            this.$children.forEach(c => {
                c.$on("pinned", (v) => {
                    if(v){
                        this.$children.forEach(c => c.endSort() );
                    }else{
                        this.$children.forEach(c => c.startSort() );
                    }
                
                });

                c.$on("sortstop", this.sortStop);
            });
        }, computed: {
            isDragDrop() {
                return this.$children.some(c => {
                    return !c.isPinned();
                });
            }
        }, methods: {
            sortStop() {
                var grid = $(this.$el);

                var data = [];
                grid.children("div.row").each(function (i, row) {
                    data[i] = [];
                    $(row).children("section").each(function (j, section) {
                        data[i][j] = [];

                        $(section).children("div[grid-item]").each(function (k, item) {
                            data[i][j].push($(item).attr("grid-item"));
                        });
                    });
                });
                this.$http.post("UI/save", {
                    type: 'grid',
                    layout: data,
                    uri: this.$attrs["data-uri"]
                }).then(resp => {

                });

            }
        }
    });
</script>