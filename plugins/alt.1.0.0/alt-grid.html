<template id="alt-grid-section">
    <section :style="getStyle()">
        <slot ref="s"></slot>
    </section>
</template>

<script>
    Vue.component("alt-grid-section", {
        template: document.currentScript.ownerDocument.getElementById("alt-grid-section"),
        computed: {
            box() {
                if (!this.$slots.default) return [];
                return this.$slots.default.filter(o => {
                    if (o.componentOptions == undefined) return false;
                    return o.componentOptions.tag == "alt-box";
                }).map(o => {
                    return o.componentInstance;
                });
            }
        }, data() {
            return {
                dragdrop: false
            }
        }, mounted() {


            $(this.$el).sortable({
                placeholder: "sort-highlight",
                connectWith: ".connectedSortable",
                handle: ".box-header, .nav-tabs",
                forcePlaceholderSize: true,
                zIndex: 999999
            }).on("sortstop", (event, ui) => {
                this.$emit("sortstop");
            });

            this.$children.forEach(c => {
                c.$on("pinned", (v) => {
                    this.$emit("pinned");
                });
            });
        }, methods: {
            getStyle() {
                if (this.dragdrop) {
                    return { "min-height": "100px" };
                } else {
                    return { "min-height": "0px" };
                }
            }, isPinned() {
                //no children
                if (this.$children.length == 0) return true;
                return this.$children.every((b) => {
                    return b.isPinned;
                });
            }
        }
    });
</script>

<template id="alt-grid">
    <div>
        <slot></slot>
    </div>
</template>

<script>
    Vue.component("alt-grid", {
        template: document.currentScript.ownerDocument.getElementById("alt-grid"),
        props: {
            dataUrl: String
        },
        mounted() {
            this.$children.forEach(c => {
                c.$on("pinned", () => {
                    this.reloadDragDrop();
                });

                c.$on("sortstop", this.sortStop);
            });
        }, computed: {
            isDragDrop() {
                return this.$children.some(c => {
                    return !c.isPinned();
                });
            }
        }, methods: {
            reloadDragDrop() {
                this.$children.forEach(c => {
                    c.dragdrop = this.isDragDrop;
                });
            }, sortStop() {
                var grid = $(this.$el);

                var data = [];
                grid.children("div.row").each(function (i, row) {
                    data[i] = [];
                    $(row).children("section").each(function (j, section) {
                        data[i][j] = [];

                        $(section).children("div[grid-item]").each(function (k, item) {
                            data[i][j].push($(item).attr("grid-item"));
                        });
                    });
                });
                this.$http.post("UI/save", {
                    type: 'grid',
                    layout: data,
                    uri: this.$attrs["data-uri"]
                }).then(resp => {

                });

            }
        }
    });
</script>