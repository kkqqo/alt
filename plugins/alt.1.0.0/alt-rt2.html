<style>
    table.rt>thead button.multiselect {
        height: 25px;
        padding: 0px;
        background-color: white;
    }
</style>
<script>
    var importDoc = document.currentScript.ownerDocument;
    var style = importDoc.querySelector('style');
    document.head.appendChild(style);
</script>
<script type="x-template" id="alt-column-search">
    <td>
        <input v-if="searchable && searchType=='text'" type="text" class="form-control input-sm search" v-model="search" @keyup.enter="doSearch()" />
        <input v-if="searchable && searchType=='equal'" type="text" class="form-control input-sm search" v-model="search" @keyup.enter="doSearch()" />
        <input v-if="searchable && searchType=='date'" class="form-control input-sm search" value="" ref="search"/>

        <select v-if="searchable && searchType=='select' && !searchOptGroup" class="form-control search" ref="search" v-model="search" v-on:change="doSearch()">
            <option></option>
            <option v-for="o in searchOption" v-bind:value="o.value" v-text="o.label"></option>
        </select>

        <select v-if="searchable && searchType=='select' && searchOptGroup" class="form-control search" ref="search" v-model="search" v-on:change="doSearch()">
            <option></option>
            <optgroup v-for="(label,group) in searchOptGroup" v-bind:label="label">
                <option v-for="o in searchOption" v-bind:value="o.value" v-text="o.label" v-if="o.group==group"></option>
            </optgroup>

        </select>

        <select v-if="searchable && searchType=='multiselect'" v-bind:multiple="searchMultiple" class="form-control search" ref="search">
            <option v-if="!searchMultiple" value="">None selected</option>
            
            <option v-if="!searchOptGroup" v-for="o in searchOption" v-bind:value="o.value" v-text="o.label"></option>
            
            <optgroup v-if="searchOptGroup" v-for="(label,group) in searchOptGroup" v-bind:label="label">
                <option v-for="o in searchOption" v-bind:value="o.value" v-text="o.label" v-if="o.group==group"></option>
            </optgroup>
    
        </select>

    </td>
</script>

<script>
    Vue.component("alt-column-search", {
        template: document.currentScript.ownerDocument.getElementById("alt-column-search"),
        props: {
            name: String,
            data: String,
            searchOption: Array,
            searchType: String,
            searchable: Boolean,
            searchOptGroup: Array,
            searchMultiple: Boolean
        }, data() {
            return {
                search: ""
            }
        }, mounted() {
            if (this.searchType == "text") {
                //console.log(this.$refs.search);
            }
            if (this.searchType == "multiselect") {
                var search = $(this.$refs.search);
                search.multiselect({
                    enableFiltering: true,
                    buttonWidth: "100%"
                });

                search.on("change", () => {
                    this.$emit("search", this.name, search.val());
                });

                return;
            }
            if (this.searchType == "date") {
                var search = $(this.$refs.search);
                search.daterangepicker({
                    //singleDatePicker: true,
                    opens: "center",
                    showDropdowns: true,
                    //"autoApply": true,
                    autoUpdateInput: false,
                    locale: {
                        format: 'YYYY-MM-DD',
                        cancelLabel: 'Clear'
                    }, ranges: {
                        'Today': [moment(), moment()],
                        'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                        'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                        'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                        'This Month': [moment().startOf('month'), moment().endOf('month')],
                        'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                    }
                });

                search.on('apply.daterangepicker', (ev, picker) => {

                    if (picker.startDate.format("YYYY-MM-DD") == picker.endDate.format("YYYY-MM-DD")) {
                        search.val(picker.startDate.format("YYYY-MM-DD"));
                    } else {
                        search.val(picker.startDate.format("YYYY-MM-DD") + " to " + picker.endDate.format("YYYY-MM-DD"));
                    }


                    var s = {};
                    s.from = picker.startDate.format("YYYY-MM-DD");
                    s.to = picker.endDate.format("YYYY-MM-DD");

                    this.search = s;
                    this.doSearch();
                });

                search.on('cancel.daterangepicker', (ev, picker) => {
                    search.val("");
                    this.search = "";
                    this.doSearch();
                });
            }
        }, methods: {
            doSearch() {
                this.$emit("search", this.name, this.search);
            }
        }


    });

</script>

<script type="x-template" id="rt2-tbody">
    <tbody>
        <template v-for="(d,index) in data">
            <tr v-on:click="onClickRow(d)" v-bind:class="getRowClass(d)">
                <td v-if="hasHideColumn">
                    <button class="btn btn-default btn-xs" 
                        v-on:click="toggleRowChild(index)" 
                        v-on:mouseenter="mouseEnterRow(index)" 
                        v-on:mouseleave="mouseLeaveRow(index)">
                        <i v-if="!showIndex[index]" class="fa fa-fw fa-chevron-up"></i>
                        <i v-if="showIndex[index]" class="fa fa-fw fa-chevron-down"></i>
                    </button>
                </td>
                <td v-for="column in columns" v-if="column.isDisplay()" v-on:click="onClickCell(column,index)" v-bind:style="column.cell(d).style">
                   <template v-if="isEditMode(column,index)" >
                        <template v-if="column.editType=='text'">
                            <input type="text" class="form-control input-sm" v-bind:value="column.getValue(d)" v-on:blur="updateData(index,d,column,$event.target.value)"/>
                        </template>
                        <template v-else-if="column.editType=='select'">
                            <select class="formControl" v-on:blur="updateData(index,d,column,$event.target.value)">
                                <option v-for="opt in column.editData" v-bind:value="opt.value" v-text="opt.label"
                                v-bind:selected="opt.value==column.getValue(d).value"></option>
                            </select>
                        </template>
                        <template v-else-if="column.editType=='date'">
                            <input type="text" class="form-control input-sm" v-bind:value="column.getValue(d)" v-on:blur="updateData(index,d,column,$event.target.value)"/>
                        </template>
                    </template>
                    <template v-else>
                        <div v-if="column.cell(d).type=='html'" v-html="column.getContent(d)"></div>
                        <div v-if="column.cell(d).type=='text'" v-text="column.getContent(d)"></div>
                        <input type="checkbox" v-if="column.type=='checkbox'" is="icheck" />
                        <input type="checkbox" v-if="column.type=='deletes'"/>
                        <button class="btn btn-xs btn-danger" v-else-if="column.cell(d).type=='delete'" v-on:click="deleteRow(d[column.data].content)"><i class="fa fa-fw fa-times"></i></button>
                        <button class="btn btn-xs btn-default" v-else-if="column.type=='sub-row'" v-on:click="toggleSubRow(index,r)">
                            <i v-if="subRow[index]" class="fa fa-fw fa-minus"></i>
                            <i v-if="!subRow[index]" class="fa fa-fw fa-plus"></i>
                        </button>
                        <a v-else-if="column.type=='link'" v-bind:href="column.href" v-html="column.content"></a>
                    </template>
                </td>
            </tr>
            <tr class="child" v-show="showChild(index)">
                <td v-bind:colspan="showColumnCount">
                    <ul>
                        <li v-for="column in columns" v-if="column.hide">
                            <b v-html="column.title"></b>&nbsp;&nbsp;
                            <span v-if="column.cell(d).type=='html'" v-html="column.getContent(d)"></span>
                            <span v-if="column.cell(d).type=='text'" v-text="column.getContent(d)"></span>
                        </li>
                    </ul>
                </td>
            </tr>
        </template>
    </tbody>
</script>


<script>
    Vue.component("rt2-tbody", {
        template: document.currentScript.ownerDocument.getElementById("rt2-tbody"),
        props: {
            data: Array,
            columns: Array,
            selectable: Boolean
        }, data() {
            return {
                hoverChild: [],
                showIndex: [],
                editMode: false,
                editColumn: null,
                editIndex: null,
                selectedData: []
            };
        }, computed: {
            hasHideColumn() {
                return this.columns.some(o => o.hide);
            }, showColumnCount() {
                return this.columns.filter(c => {
                    return !c.hide;
                }).length + 1;
            }
        }, methods: {
            getRowClass(d) {
                var c = [];
                if (this.isSelected(d)) {
                    c.push("selected");
                }
                if (d.__row__) {
                    c = c.concat(d.__row__.class);
                }

                return c;
            },
            deleteRow(uri) {
                if (confirm("Are your sure?")) {
                    this.$http.get(uri).then(resp => {
                        this.$emit("data-deleted");
                    });
                }

            },
            isSelected(d) {
                return this.selectedData.indexOf(d) >= 0;
            },
            onClickRow(d) {
                if (!this.selectable) return;
                if (this.isSelected(d)) {
                    var index = this.selectedData.indexOf(d);
                    this.selectedData.splice(index, 1);
                } else {
                    this.selectedData.push(d);
                }


            },
            isEditMode: function (column, index) {
                if (!this.editMode) return false;
                if (this.editColumn == column && this.editIndex == index) {
                    return true;
                }
                return false;
            },
            onClickCell: function (column, index, r) {
                if (!column.editable) return false;
                this.editMode = true;
                this.editColumn = column;
                this.editIndex = index;
            },
            showAllChild() {
                this.data.forEach((o, i) => {
                    this.showIndex[i] = true;
                });
                this.$forceUpdate();
            },
            hideAllChild() {
                this.data.forEach((o, i) => {
                    this.showIndex[i] = false;
                });
                this.$forceUpdate();
            }, toggleRowChild(index) {
                this.showIndex[index] = !this.showIndex[index];
                this.$forceUpdate();
            },
            showChild(index) {
                if (this.hoverChild[index]) return true;
                return this.showIndex[index];
            }, mouseLeaveRow(index) {
                this.hoverChild[index] = false;
                this.$forceUpdate();
            }, mouseEnterRow(index) {
                this.hoverChild[index] = true;
                this.$forceUpdate();
            }, updateData(index, r, column, value) {
                if (!column.editable) return;
                this.editMode = false;

                if (column.editType == "text") {
                    if (column.getValue(r) != value) {
                        r[column.data] = value;
                        this.$emit("update-data", r._key, column.data, value);
                    }
                    return;
                }

                if (column.editType == "select") {
                    if (r[column.data].value != value) {
                        r[column.data].value = value;
                        r[column.data].content = column.editData[value].label;
                        this.$emit("update-data", r._key, column.data, value);
                    }
                }
                /* else {
                    if (r[column.field] != value) {
                        r[column.field] = value;
                        this.$emit("update-data", r._key, column.field, value);
                    }
                }*/
            },
        }
    });
</script>


<template id="alt-rt2">
    <div class="box no-border" is="alt-box" ref="box">
        <div class="box-body no-padding" is="alt-box-body" :class="{'table-responsive':!responsive}">
            <table class="table table-hover table-condensed table-bordered rt" ref="table">
                <thead>
                    <tr>
                        <td v-if="hasHideColumn">
                            <button class="btn btn-default btn-xs" v-on:click="toggleChild">
                                <i v-if="!showChild" class="fa fa-fw fa-chevron-up"></i>
                                <i v-if="showChild" class="fa fa-fw fa-chevron-down"></i>
                            </button>
                        </td>
                        <th v-for="(column,key) in columns" is="alt-column" v-bind="column.$data" v-if="column.isDisplay()" v-on:order="order" v-on:draw="draw"
                            ref="column"></th>
                    </tr>
                    <tr v-if="isSearchable">
                        <td v-if="hasHideColumn">
                        </td>
                        <td v-for="(column,key) in columns" is="alt-column-search" v-bind="column.$data" v-if="column.isDisplay()" v-on:search="search"></td>
                    </tr>
                </thead>
                <tbody is="rt2-tbody" :selectable="selectable" :data="data()" :columns="columns" ref="tbody" v-on:update-data="updateData"
                    v-on:data-deleted="draw"></tbody>
            </table>
        </div>
        <div class="box-footer">
            <rt-pagination :page="page" :page-count="pageCount" v-on:change-page="gotoPage" v-on:first-page="firstPage" v-on:next-page="nextPage"
                v-on:prev-page="prevPage" v-on:last-page="lastPage"></rt-pagination>

            <div class="pull-left btn-group">
                <button @click="draw" class="btn btn-default btn-sm" type="button" title="重新載入" data-toggle="tooltip">
                    <i class="fa fa-sync-alt"></i>
                </button>
            </div>

            <div class="pull-left">
                <select class="form-control input-sm" @change="onChangePageLength" v-model="local.pageLength">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="500">500</option>
                </select>
            </div>


            <div class="pull-left dropup">
                <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown">
                    <span class="icon glyphicon glyphicon-th-list"></span>
                </button>
                <ul class="dropdown-menu" ref="column_menu">
                    <li v-for="(column,key) in columns" v-if="column.title" :key="key">
                        <a href="#" class="small" data-value="option1" tabIndex="-1" @click.prevent="column.toggleVisible()">
                            <input type="checkbox" v-model="column.isVisible" />&nbsp;{{column.title}}
                        </a>
                    </li>
                </ul>
            </div>


            <div class="pull-left btn-group">
                <button @click="toggleResponsive" :class="{active:responsive}" class="btn btn-default btn-sm" type="button" title="Responsive"
                    data-toggle="tooltip">
                    <i class="fa fa-tv"></i>
                </button>

                <button @click="resetLocaStorage" class="btn btn-default btn-sm" type="button" title="clear cache" data-toggle="tooltip">
                    <i class="fa fa-times-circle"></i>
                </button>
            </div>

            <div class="pull-left dropdown" v-if="hasExport()">
                <button class="btn btn-default btn-sm dropdown-toggle" type="button" data-toggle="dropdown">
                    Export
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                    <li v-if="exports.indexOf('xlsx')>=0">
                        <a href="#" @click.prevent="exportFile('xlsx')">XLSX</a>
                    </li>
                    <li v-if="exports.indexOf('csv')>=0">
                        <a href="#" @click.prevent="exportFile('csv')">CSV</a>
                    </li>
                </ul>
            </div>

            <div class="pull-left btn-group">
                <button v-for="(button,index) in buttons" @click="onClickButton(button)" class="btn btn-default btn-sm" type="button" v-text="button.text">
                </button>
            </div>

            <rt-info class="pull-right" v-bind="info"></rt-info>
        </div>
    </div>
</template>

<script type="x-template" id="alt-column">
    <th v-on:click="click" class="unselectable" v-bind:style="getStyle()"
    v-bind:class="{
        sortable:orderable,
        sorting_desc:(orderDir=='desc'),
        sorting_asc:(orderDir=='asc')
    }">
        <input v-if="type=='checkbox'" type="checkbox" is="icheck" v-on:change="checkboxChange"/>
        <div v-else v-text="title"></div>
    </th>
</script>

<script>
    Vue.component("alt-column", {
        template: document.currentScript.ownerDocument.getElementById("alt-column"),
        props: {
            name: String,
            data: String,
            title: String,
            orderable: Boolean,
            orderDir: String,
            isVisible: {
                type: Boolean,
                default: true
            }, width: String,
            type:String
        }, data() {
            return {
                hide: false,
                local: {
                    orderDir: ""
                }
            };
        }, methods: {
            checkboxChange(e){
                console.log(e.target.checked);
            },
            click() {
                if (!this.orderable) return;
                if (this.local.orderDir == "desc") {
                    this.order("asc");
                } else {
                    this.order("desc");
                }
                this.draw();
            }, search(search) {
                this.local.search = search;
                return this;
            }, order(dir) {
                if (!this.orderable) return this;
                this.local.orderDir = dir;
                this.$emit("order", [this.name, dir]);
                return this;
            }, draw() {
                this.$emit("draw");
                return this;
            }, getStyle() {
                let style = {};
                if (this.width) {
                    style["min-width"] = this.width;
                }
                return style;

            }
        }
    });

    Vue.component("alt-rt2", {
        template: document.currentScript.ownerDocument.getElementById("alt-rt2"),
        props: {
            ajax: {
                type: Object,
                default: {}
            }, pageLength: {
                type: Number,
                default: 10
            }, cellUrl: String,
            selectable: Boolean,
            buttons: {
                type: Array,
                default: () => { return [] }
            }, exports: {
                type: Array,
                default: () => { return [] }
            }
        },
        data: function () {
            var storage = $.localStorage.get(this.ajax.url) || {};

            var data = {
                hoverChild: [],
                total: 0,
                showChild: false,
                showIndex: [],
                local: {
                    search: [],
                    draw: 1,
                    pageLength: this.pageLength,
                    order: this.$attrs.order
                },
                page: 1,
                remoteData: [],
                columns: [],
                responsive: this.$attrs.responsive
            };

            if (typeof storage.responsive !== "undefined") {
                data.responsive = storage.responsive;
            }

            if (typeof storage.pageLength !== "undefined") {
                data.local.pageLength = parseInt(storage.pageLength);
            }


            return data;
        },
        created: function () {
            this.columns = this.$attrs.columns.map(o => {
                o.hide = false;
                o.orderDir = "";
                this.local.order.forEach(ord => {
                    if (ord.name == o.name) {
                        o.orderDir = ord.dir;
                    }
                });

                return new Vue({
                    data: o,
                    props: {
                        isVisible: {
                            type: Boolean,
                            default: true
                        }
                    },
                    methods: {
                        cell(d) {
                            var cell = {
                                type: "text"
                            };
                            if (this.cellStyle) {
                                cell.style = { ...cell.style, ...this.cellStyle };
                            }


                            if (this.wrap) {
                                cell.style = {
                                    ...cell.style, ...{
                                        "word-wrap": "break-word",
                                        "white-space": "pre-wrap"
                                    }
                                };
                            }

                            if (d[this.name] == null) {
                                return cell;
                            } else {
                                for (var i in d[this.name]) {
                                    cell[i] = d[this.name][i];
                                }
                            }


                            return cell;
                        },
                        isDisplay() {
                            return this.isVisible && !this.hide;
                        },
                        getContent(d) {
                            var o = d[this.name];

                            if(o===null)return "";

                            if (Array.isArray(o)) {
                                return o.join(" ");
                            }

                            if (typeof o == "object") {
                                return o.content;
                            }

                        },
                        getValue(d) {
                            var o = d[this.name];
                            if (!o) return "";

                            if (typeof o == "object") {
                                if (o.type == "raw") {
                                    return o.content;
                                } else {
                                    return o.value;
                                }
                            }
                            return o;
                        }, toggleVisible() {
                            this.isVisible = !this.isVisible;
                        }
                    }
                });
            });
        },
        mounted() {

            if (this.ajax.url) {
                this.draw();
            }

            window.addEventListener('resize', this.resize);
        }, computed: {
            pageCount() {
                return Math.ceil(this.total / this.local.pageLength);
            },
            info() {
                return {
                    from: (this.page - 1) * this.pageLength + 1,
                    to: Math.min(this.page * this.pageLength, this.total),
                    total: this.total
                };
            }, isSearchable() {
                return this.columns.some(o => o.searchable);
            }, hasHideColumn() {
                return this.columns.some(o => o.hide);
            }
        }, methods: {
            onClickButton(button) {
                var e = button.action + "(this);";
                eval(e);
            },
            hasExport() {
                return this.exports.count > 0;
            },
            exportFile(type) {
                this.local.draw++;
                this.$http.get(this.ajax.url, {
                    params: {
                        _rt: 1,
                        draw: this.local.draw,
                        columns: this.columns.map(o => {
                            return {
                                name: o.name,
                                search: {
                                    value: this.local.search[o.name]
                                }, searchMethod: o.searchMethod
                            };
                        }), order: this.local.order,
                        search: this.searchData,
                        type: type
                    },
                    responseType: 'arraybuffer'
                }).then(function (response) {
                    //console.log(response);
                    var headers = response.headers;
                    var blob = new Blob([response.data], {
                        type: headers['content-type']
                    });
                    var link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    if (type == "xlsx") {
                        link.download = "export.xlsx";
                    } else if (type == "csv") {
                        link.download = "export.csv";
                    }

                    link.click();
                });
            },
            updateData(key, field, value) {
                if (!this.cellUrl) {
                    console.log("cell-url not found");
                    return;
                }
                this.$http.post(this.cellUrl, {
                    _pk: key,
                    name: field,
                    value: value
                }).then((resp) => {
                    console.log("done");
                });
            },
            resetLocaStorage() {
                $.localStorage.remove(this.ajax.url);
                this.draw();
            },
            toggleResponsive() {
                this.responsive = !this.responsive;

                //save 
                var storage = $.localStorage.get(this.ajax.url) || {};
                storage.responsive = this.responsive;
                $.localStorage.set(this.ajax.url, storage);

                this.resize();
            },
            toggleChild() {
                this.showChild = !this.showChild;
                if (this.showChild) {
                    this.$refs.tbody.showAllChild();
                } else {
                    this.$refs.tbody.hideAllChild();
                }
                this.$forceUpdate();
            }, getColumn(index) {
                return this.columns[index];
            }, onChangePageLength() {

                //save 
                var storage = $.localStorage.get(this.ajax.url) || {};
                storage.pageLength = this.local.pageLength;
                $.localStorage.set(this.ajax.url, storage);

                this.page = 1;
                this.draw();
            }, gotoPage(page) {
                this.page = parseInt(page);
                this.draw();
            }, firstPage() {
                this.page = 1;
                this.draw();
            }, nextPage() {
                this.page++;
                this.draw();
            }, prevPage() {
                this.page--;
                this.draw();
            }, lastPage() {
                this.page = this.pageCount;
                this.draw();
            }, data() {
                return this.remoteData;
            }, order(o) {
                this.local.order = [{
                    name: o[0],
                    dir: o[1]
                }];
                this.columns.forEach(c => {
                    if (c.name != o[0]) {
                        c.orderDir = "";
                    } else {
                        c.orderDir = o[1];
                    }
                });
                return this;
            }, draw() {
                this.$refs.box.showLoading();
                this.local.draw++;
                this.$http.get(this.ajax.url, {
                    params: {
                        _rt: 1,
                        draw: this.local.draw,
                        columns: this.columns.map(o => {
                            return {
                                name: o.name,
                                search: {
                                    value: this.local.search[o.name]
                                }, searchMethod: o.searchMethod
                            };
                        }), order: this.local.order,
                        page: this.page,
                        length: this.local.pageLength
                    }
                }).then(resp => {
                    this.$refs.box.hideLoading();
                    try {
                        if (resp.data.draw < this.local.draw) {
                            return;
                        }

                        this.remoteData = resp.data.data;
                        this.total = resp.data.total;

                        this.resize();
                    } catch (e) {
                        alert(e.message);
                    }
                })
            }, search(name, value) {
                this.page = 1;
                this.local.search[name] = value;
                this.draw();
                return this;
            }, resize() {
                this.columns.forEach((c) => {
                    c.hide = false;
                });

                if (!this.responsive) return;

                this.$nextTick(() => {
                    //console.log("--");
                    var parentWidth = this.$refs.table.parentElement.offsetWidth;
                    //console.log("parentWidth", parentWidth);


                    var total = () => {
                        let total = 0;
                        this.columns.forEach((c, i) => {
                            let c_el = this.$refs.column[i];
                            if (c_el) {
                                total += c_el.$el.offsetWidth;
                            }

                        });
                        if (this.columns.some((c) => {
                            return c.hide
                        })) {
                            total += 32;
                        }
                        return total;
                    };

                    var hideLastColumn = () => {
                        let columns = this.columns.filter((c) => {
                            if (c.noHide) {
                                return false;
                            }
                            return !c.hide
                        });
                        columns = columns.reverse();
                        if(columns.length>0){
                            columns[0].hide = true; //hide last column
                            return true;
                        }else{
                            return false;//nothing can hide
                        }
                    };

                    var check = () => {
                        let t = total();
                        //console.log(t);
                        if (t > parentWidth) {
                            var r=hideLastColumn();

                            if(r){
                                this.$nextTick(() => {
                                    check();
                                });
                            }
                        }
                    }

                    check();
                });
            }
        }
    });

</script>